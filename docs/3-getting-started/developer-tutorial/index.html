<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<title>SeqWare › Developer Tutorial</title>
<meta content="nanoc 3.4.0" name="generator">
<link href="../../../assets/style-v17.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://feeds.feedburner.com/seqware" rel="alternate" title="The SeqWare Blog" type="application/atom+xml">
<script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34523087-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script>
</head>
<body>
<div class="wrapper">
<!-- ***** navigation ***** -->
<div class="nav">
<ol>
<li><a href="../../../"><span>Home</span></a></li>
<li><a href="../../../blog/"><span>News</span></a></li>
<li><a href="../../"><span>Documentation</span></a></li>
<li><a href="../../../community/"><span>Community</span></a></li>
<li><a href="../../../partners/"><span>Partners</span></a></li>
<li><a href="../../../about/"><span>About</span></a></li>
</ol>
</div>
<!-- ***** sidebar ***** -->
<div class="side">
<ol>
<li><a href="../../1-introduction/"><span>Introduction to SeqWare</span></a></li>
<li><a href="../../2-installation/"><span>Installation</span></a></li>
<li>
<a href="../"><span>Getting Started</span></a><ol class="toc">
<li><a href="#by-the-end-of-this-tutorial">By the End of This Tutorial</a></li>
<li><a href="#first-steps">First Steps</a></li>
<li><a href="#overview-of-workflow-development-using-the-vm">Overview of Workflow Development Using the VM</a></li>
<li><a href="#generating-workflow-bundles">Generating Workflow Bundles</a></li>
<li><a href="#listing-the-workflow">Listing the Workflow</a></li>
<li><a href="#ensure-that-the-files-in-the-workflow-bin-directory-are-executable">Ensure that the files in the Workflow bin directory are executable</a></li>
<li><a href="#test-the-myhelloworld-workflow-bundle-on-the-vm">Test the MyHelloWorld Workflow Bundle on the VM</a></li>
<li><a href="#packaging-and-installing-the-myhelloworld-locally">Packaging and Installing the MyHelloWorld Locally</a></li>
<li><a href="#generate-an-ini-file">Generate an ini file</a></li>
<li><a href="#schedule-a-workflow">Schedule a workflow</a></li>
<li><a href="#launch-a-workflow">Launch a Workflow</a></li>
<li><a href="#monitoring-workflows">Monitoring Workflows</a></li>
<li><a href="#final-thoughts">Final Thoughts</a></li>
<li><a href="#next-steps">Next Steps</a></li>
</ol>
</li>
<li><a href="../../4-metadb/"><span>SeqWare MetaDB</span></a></li>
<li><a href="../../5-portal/"><span>SeqWare Portal</span></a></li>
<li><a href="../../6-pipeline/"><span>SeqWare Pipeline</span></a></li>
<li><a href="../../7-web-service/"><span>SeqWare Web Service</span></a></li>
<li><a href="../../8-query-engine/"><span>SeqWare Query Engine</span></a></li>
<li><a href="../../9-glossary/"><span>Glossary</span></a></li>
<li><a href="../../10-faq/"><span>Frequently Asked Questions</span></a></li>
<li><a href="../../11-api/"><span>APIs</span></a></li>
<li><a href="../../13-code/"><span>Source Code</span></a></li>
<li><a href="../../17-plugins/"><span>Plugins</span></a></li>
</ol>
</div>
<!-- ***** body ***** -->
<div class="body">
<div class="article">
<div class="header">
<h1>Developer Tutorial</h1>
</div>
<p>This guide picks up where the <a href="../user-tutorial/">User Tutorial</a> left off. In that previous guide we showed you how to start up your local VM, create studies, experiments, and samples, associate an input file with a sample, and then launch a workflow to process that file.  This process is the same generic process we use at OICR to analyze samples from fastq to, eventually, annotated variants.  In this production system the workflows are fairly complex (they include branching and looping) and we string multiple worklfows together (output of one as input for the next) using <kbd>deciders</kbd>.</p>

<p>The next step presented in this tutorial is to create a workflow of your own based on the HelloWorld that comes bundled with the VM.  In theory you could use either a local VM or an Amazon instance to follow the tutorial below but in our case we will base it on the local VM.</p>

<div class="section" id="by-the-end-of-this-tutorial">
<h2>By the End of This Tutorial</h2>

<p>By the end of these tutorials you will:</p>

<ul>
<li>create a new SeqWare Pipeline workflow bundle based on HelloWorld</li>
  <li>package, install, schedule, and run your new workflow bundle in Pipeline and MetaDB</li>
  <li>generate a report on the outputs of your workflows in Pipeline and Portal</li>
  <li>be prepared to move on to more detailed documentation for each sub-project</li>
</ul>
<p class="warning"><strong>WARNING:</strong>These directions are updated to include Maven archetypes.  The traditional maven archetypes do not mark items in the ${workflow_bundle_dir}/bin as executable.  This will cause workflows to immediatly fail and you have to &#8220;chmod&#8221; the binaries in the workflow bundles created with &#8220;mvn install&#8221;. For example &#8220;chmod -R a+x Workflow_Bundle_simple-legacy-ftl-workflow/1.0-SNAPSHOT/bin/*&#8221;.</p>

</div>
<div class="section" id="first-steps">
<h2>First Steps</h2>

<p>Please launch your local VM in VirtualBox and login as user <kbd>seqware</kbd>, password <kbd>seqware</kbd> at this time. Click on the “SeqWare Directory” link on the desktop which will open a terminal to the location where we installed the SeqWare tools. </p>

</div>
<div class="section" id="overview-of-workflow-development-using-the-vm">
<h2>Overview of Workflow Development Using the VM</h2>

<p>You should be in the ~seqware/SeqWare directory now, this is
the working directory.  Notice there is a jar file here and also two important
directories: provisioned-bundles which contains unzipped workflow bundles and
is where you will work on new bundles and released-bundles (SW_BUNDLE_REPO_DIR
in the config) which contains zip versions of the workflows that you create
when you package up these bundles and install them locally or on the cloud. You
will work in provisioned-bundles, copying a template HelloWorld workflow to a
new bundle that you can modify You will also test your bundles from there as
well. Once you finish with the new bundle you will package and install it via
the web service (to either the remote cloud VM or local VM). Once
installed you can use the workflow scheduling tools you have used before to
trigger workflows (on the cloud or the local VM), monitor them, and get data
back.</p>

<p>Please note that the parent of this directory also contains a copy of the SeqWare source code retrieved via the procedure in <a href="../../13-code/">source code</a>.</p>

<p>First, build SeqWare and then copy the distribution jar to your home and name it somethign convenient. </p>

<pre><code>cd ~/seqware-github-development/
cp seqware-distribution/target/seqware-distribution-0.13.6-SNAPSHOT-full.jar ~/seqware-full.jar
</code></pre>

</div>
<div class="section" id="generating-workflow-bundles">
<h2>Generating Workflow Bundles</h2>

<p>Generate your workflow bundles using Maven archetypes. </p>

<pre><code>mvn archetype:generate
# 690: local -&gt; com.github.seqware:seqware-archetype-simple-legacy-ftl-workflow (A very simple SeqWare legacy ftl workflow archetype)
</code></pre>

</div>
<div class="section" id="listing-the-workflow">
<h2>Listing the Workflow</h2>

<pre><code>seqware@seqwarevm Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow]$ java -jar ~/seqware-github-development/seqware-distribution/target.jar -p net.sourceforge.seqware.pipeline.plugins.BundleManager -- -l -b `pwd`

Running Plugin: net.sourceforge.seqware.pipeline.plugins.BundleManager
Setting Up Plugin: net.sourceforge.seqware.pipeline.plugins.BundleManager@25595f51

List Workflows:

 Workflow:
  Name : hello
  Version : 1.0
  Description : Add a description of the workflow here.
  Test Command: java -jar ${workflow_bundle_dir}/Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow/1.0-SNAPSHOT/lib/seqware-distribution-0.13.3-full.jar --plugin net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher -- --no-metadata --provisioned-bundle-dir ${workflow_bundle_dir} --workflow hello --version 1.0 --ini-files ${workflow_bundle_dir}/Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow/1.0-SNAPSHOT/config/workflow.ini
  Template Path:${workflow_bundle_dir}/Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow/1.0-SNAPSHOT/workflows/workflow.ftl
  Config Path:${workflow_bundle_dir}/Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow/1.0-SNAPSHOT/config/workflow.ini
  Requirements Compute: single Memory: 20M Network: local
</code></pre>

</div>
<div class="section" id="ensure-that-the-files-in-the-workflow-bin-directory-are-executable">
<h2>Ensure that the files in the Workflow bin directory are executable</h2>

<pre><code>chmod -R a+x Workflow_Bundle_simple-legacy-ftl-workflow/1.0-SNAPSHOT/bin/*
</code></pre>

</div>
<div class="section" id="test-the-myhelloworld-workflow-bundle-on-the-vm">
<h2>Test the MyHelloWorld Workflow Bundle on the VM</h2>

<pre><code>java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.BundleManager -- -b `pwd` -t --workflow simple-legacy-ftl-workflow --version 1.0

Running Plugin: net.sourceforge.seqware.pipeline.plugins.BundleManager
Setting Up Plugin: net.sourceforge.seqware.pipeline.plugins.BundleManager@e80d1ff
Testing Bundle
  Running Test Command:
java -jar /home/seqware/Temp/simple-legacy-ftl-workflow/target/Workflow_Bundle_simple-legacy-ftl-workflow_1.0-SNAPSHOT_SeqWare_0.13.3/Workflow_Bundle_simple-legacy-ftl-workflow/1.0-SNAPSHOT/lib/seqware-distribution-0.13.3-full.jar --plugin net.sourceforge.seqware.pipeline.plugins.Workflow-provisioned-bundle-dir /home/seqware/Temp/simple-legacy-ftl-workflow/target/Workflow_Bundle_simple-legacy-ftl-workflow_1.0-SNAPSHOT_SeqWare_0.13.3 --workflow simple-legacy-ftl-workflow --version 1.0 --ini-files /home/seqware/Temp/simple-legacy-ftl-workflow/target/Workflow_Bundle_simple-lSHOT_SeqWare_0.13.3/Workflow_Bundle_simple-legacy-ftl-workflow/1.0-SNAPSHOT/config/workflow.ini
MONITORING PEGASUS STATUS:
RUNNING: step 1 of 5 (20%)
RUNNING: step 2 of 5 (40%)
</code></pre>

</div>
<div class="section" id="packaging-and-installing-the-myhelloworld-locally">
<h2>Packaging and Installing the MyHelloWorld Locally</h2>

<p>Assuming the workflow above worked fine the next step is to install it locally,
this means it will be inserted into the MetaDB via the locally running web
service.  During this process it will zip up the workflow bundle and put it
into your released-bundles directory. Once you have the zip file you can share it with
other users and, in the future, upload it to an AppStore to make it even easier to share.</p>

<p>Here is an example showing how this
process works on the VM and what is happening in the database and your
released-bundles directory as you do this.  You may want to delete the zip file
that is in the released-bundles directory before you do this step below (or back
it up somewhere first).  To connect to the database in the example below you
can issue the following command in the terminal:</p>

<pre><code>psql -U seqware -W seqware_meta_db
</code></pre>

<p>…with password <code>seqware</code>.</p>

<pre><code>seqware@seqwarevm Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3]$ java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.BundleManager -- -b `pwd` -i
Running Plugin: net.sourceforge.seqware.pipeline.plugins.BundleManager
Setting Up Plugin: net.sourceforge.seqware.pipeline.plugins.BundleManager@2b5ac3c9
Installing Bundle
Bundle: /home/seqware/Temp/workflow-hello-simple-legacy-ftl-workflow/target/Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3
Now packaging /home/seqware/Temp/workflow-hello-simple-legacy-ftl-workflow/target/Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3 to a zip file and transferring to the directory: /home/seqware/SeqWare/released-bundles Please be aware, this process can take hours if the bundle is many GB in size.
Dec 4, 2012 7:34:44 PM org.restlet.ext.httpclient.HttpClientHelper start
INFO: Starting the Apache HTTP client
WORKFLOW_ACCESSION: 6730
Bundle Has Been Installed to the MetaDB and Provisioned to /home/seqware/Temp/workflow-hello-simple-legacy-ftl-workflow/target/Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3!
</code></pre>

<p>What happens here is the <code>Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3</code> directory is zip’d up to your released-bundles directory and the metadata about the workflow is saved to the database.</p>

</div>
<div class="section" id="generate-an-ini-file">
<h2>Generate an ini file</h2>
<p>Make sure you clean out the cruft from the ini file here!
Delete the lines before and after (and including) “—————————————————–”</p>

<pre><code>[seqware@seqwarevm Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3]$ java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.BundleManager -- --list-workflow-params --workflow-accession 6730 &gt; workflow.ini
Dec 4, 2012 7:36:34 PM org.restlet.ext.httpclient.HttpClientHelper start
INFO: Starting the Apache HTTP client
vim workflow.ini 
</code></pre>

<p>Now, we will try to schedule the workflow to the database instead of running it directly (people running workflows in production and deciders should take this approach rather than executing directory with WorkflowLauncher and –wait)</p>

</div>
<div class="section" id="schedule-a-workflow">
<h2>Schedule a workflow</h2>

<pre><code>Note when scheduling, you need --host.  This will now correctly schedule the workflow in the database

[seqware@seqwarevm Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3]$ java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher -- --ini-files workflow.ini --workflow-accession 6730 --schedule --parent-accessions 839 --host `hostname --long`
Running Plugin: net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher
Setting Up Plugin: net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher@e80d1ff
Dec 4, 2012 7:40:45 PM org.restlet.ext.httpclient.HttpClientHelper start
INFO: Starting the Apache HTTP client
WORKFLOW_RUN ACCESSION: 6731
</code></pre>

<p>Note that this doesn’t work!</p>

<pre><code>[seqware@seqwarevm Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3]$ java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher -- --ini-files workflow.ini --workflow-accession 6730 --schedule --parent-accessions 839
</code></pre>

</div>
<div class="section" id="launch-a-workflow">
<h2>Launch a Workflow</h2>

<p>Launch a workflow that’s been scheduled (you can tell it which one with –workflow-run-accession, typically this command is a cron). It launched workflows scheduled by your REST username where the host field in workflow_run matches the host you run this on.</p>

<pre><code>seqware@seqwarevm Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3]$ java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher -- --launch-scheduled
Running Plugin: net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher
Setting Up Plugin: net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher@25595f51
Dec 4, 2012 7:43:00 PM org.restlet.ext.httpclient.HttpClientHelper start
INFO: Starting the Apache HTTP client
Number of submitted workflows: 5
Working Run: 6705
Invalid run by host check: 6705
Working Run: 6706
Invalid run by host check: 6706
Working Run: 6683
Invalid run by host check: 6683
Working Run: 6684
Invalid run by host check: 6684
Working Run: 6731
Valid run by host check: 6731
requiresNewLauncher - fall-through
Launching via old launcher: 6731
Workflow Run 6731
Workflow: 6730
TEMPLATE FILE: /home/seqware/Temp/workflow-hello-simple-legacy-ftl-workflow/target/Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3/Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow/1.0-SNAPSHOT/workflows/workflow.ftl
INI FILES:
PARENT ACCESSIONS: 839
CREATING DAX IN: /tmp/dax695420372787314356595792546946156
TEMPLATE FILE: /home/seqware/Temp/workflow-hello-simple-legacy-ftl-workflow/target/Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3/Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow/1.0-SNAPSHOT/workflows/workflow.ftl
CREATING DAX IN: /tmp/dax695420372787314356595792546946156
  INI FILE:
  KEY: parent_accessions VALUE: 839
  KEY: parent-accessions VALUE: 839
  KEY: output_prefix VALUE: ./provisioned/
  KEY: output_dir VALUE: seqware-results
  KEY: workflow_run_accession VALUE: 6731
  KEY: parent_accession VALUE: 839
  KEY: input_file VALUE: ${workflow_bundle_dir}/Workflow_Bundle_workflow-hello-simple-legacy-ftl-workflow/1.0-SNAPSHOT/data/input.txt
  KEY: workflow-run-accession VALUE: 6731
  KEY: seqware_cluster VALUE: seqwarevm
  KEY: workflow_bundle_dir VALUE: /home/seqware/Temp/workflow-hello-simple-legacy-ftl-workflow/target/Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3
  KEY: metadata VALUE: metadata
SUBMITTING TO PEGASUS: pegasus-plan -Dpegasus.user.properties=/home/seqware/.seqware/pegasus/properties --dax /tmp/dax695420372787314356595792546946156 --dir /home/seqware/SeqWare/pegasus-dax -o seqwarevm --force --submit -s seqwarevm
PEGASUS STATUS COMMAND: pegasus-status -l /home/seqware/SeqWare/pegasus-dax/seqware/pegasus/hello/run0001
</code></pre>

</div>
<div class="section" id="monitoring-workflows">
<h2>Monitoring Workflows</h2>

<p>Monitor the running workflows (for the ones that have metadata writeback and have entries in the workflow_run table) no params here let you monitor all running workflows.  It automatically is only monitoring ones owned by your REST username and launched as your linux user on the host you’re running this command on</p>

<pre><code>java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.WorkflowStatusChecker -- --workflow-run-accession 6731
</code></pre>

<p>You can also launch with –wait, this manually runs a workflow using WorkflowLauncher (not scheduled first in the DB and not using the integrated testing via BundleManager) </p>

<pre><code>[seqware@seqwarevm Workflow_Bundle_hello_1.0-SNAPSHOT_SeqWare_0.13.3]$ java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher -- --ini-files workflow.ini --workflow-accession 6730 --parent-accessions 839 --wait --host seqwarevm
Running Plugin: net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher
MONITORING PEGASUS STATUS:
RUNNING: step 1 of 4 (25%)
RUNNING: step 2 of 4 (50%)
RUNNING: step 3 of 4 (75%)
WORKFLOW COMPLETED SUCCESSFULLY!
</code></pre>

</div>
<div class="section" id="final-thoughts">
<h2>Final Thoughts</h2>

<p>You can also launch async (without –wait), this manually runs the workflow using WorkflowLauncher but does not stick around for it to finish.  You can get in trouble here if you launch a workflow without metadata writeback in which case there will be no saved record this workflow is running!  Be careful!  Typically you will want to either schedule a workflow <em>or</em> you will want to use BundleManager to test (during development or if someone hands you a workflow budle) which runs it and monitors the status <em>or</em> you will directly launch the workflow with your own .ini file and use –wait so it sticks around monitors the progress.</p>

<pre><code> java -jar ~/seqware-full.jar -p net.sourceforge.seqware.pipeline.plugins.WorkflowLauncher -- --ini-files workflow.ini --workflow-accession 6730 --parent-accessions 839 --host seqwarevm
</code></pre>

<p>Note, when you do “BundleManager –test” you’re actually running the “old” WorkflowLauncher that’s bundled inside the workflow whereas the other techniques use the WorkflowLauncher inside the particular SeqWare jar you’re directly executing.  Just be aware if you get strange behavior with BundleManager and test, you always have the option if directly running the test with the WorkflowLauncher command. </p>

</div>
<div class="section" id="next-steps">
<h2>Next Steps</h2>

<p>The step-by-step guide at <a href="../../14-workflow-mvn/">Creating New Workflow Bundles and Modules Using Maven Archetypes</a> gives an introduction on how to create new workflows.
The guide <a href="http://sourceforge.net/apps/mediawiki/seqware/index.php?title=How_to_Write_a_Bundled_Workflow">How to Write a Workflow Bundle</a> on the public SeqWare project wiki goes into very detailed information about workflow bundles, how to create them, the syntax they use, and other key information. In the near future this will be migrated to this site but the directions there should still be up to date.</p>
</div>
</div>
</div>
</div>
<!-- ***** footer ***** -->
<div id="footer">
<p>SeqWare © 2007–2012 Brian O&#8217;Connor. SeqWare is released under the a <a rel="license" href="http://www.gnu.org/licenses/licenses.html">GNU GPL v3</a>. This site is built using the excellent <a href="http://nanoc.stoneship.org/">nanoc</a> tool and example site along with the <a href="http://www.fonts.info/info/press/free-fonts-for-font-face-embedding.htm">Graublau</a> and <a href="http://scripts.sil.org/Gentium">Gentium</a> fonts.</p>
</div>
</body>
</html>
